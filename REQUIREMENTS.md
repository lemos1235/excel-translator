# Excel 翻译器 GUI 功能实现说明文档

## 1. 项目概述

本文档详细说明了 `excel-translator` 项目中图形用户界面（GUI）部分的功能与实现。GUI 旨在为用户提供一个直观、简洁的操作界面，以完成 Excel 文件的选择、翻译和保存。它通过清晰的流程引导和实时的状态反馈，优化了用户体验，并确保了后台翻译任务的稳定运行。

该界面是使用 Go 语言的 `gioui.org/app` 库构建的，这是一个用于编写跨平台即时模式 GUI 的工具包。

## 2. 核心功能

-   **文件选择**：用户可以通过系统原生文件浏览器选择一个 `.xlsx` 格式的 Excel 文件进行翻译。
-   **状态反馈**：界面会实时显示当前操作的状态，如"正在选择..."、"正在翻译..."、"翻译成功"、"保存成功"或错误提示，让用户清楚地了解程序当前所处的阶段。
-   **实时翻译进度**：在翻译过程中，界面会展示当前正在处理的原文和对应的译文，为用户提供即时反馈。
-   **流程控制**：
    -   **开始翻译**：在选择文件后，用户可以点击"翻译"按钮启动处理流程。
    -   **重新选择**：允许用户在开始翻译前更换已选择的文件。
    -   **继续下一个**：在一次完整的翻译和保存流程结束后，用户可以点击"下一个"按钮，重置界面以开始新的翻译任务。
-   **结果保存**：翻译完成后，程序会自动弹出原生文件保存对话框，并根据原始文件名生成一个建议的译文文件名（例如 `原始文件名_译文.xlsx`），用户可以确认或修改后保存。
-   **后台处理**：文件选择、翻译和保存等耗时操作均在后台 goroutine 中执行，避免阻塞 UI 线程，保证了界面的流畅响应。
-   **临时文件管理**：程序在处理过程中使用临时文件存储中间翻译结果，确保原始文件不会被意外修改。这些临时文件在操作成功或程序退出时会自动清理。

## 3. 界面工作流

GUI 的操作流程被设计成一个线性的、单向的状态机，引导用户一步步完成任务。

1.  **初始状态**：
    -   界面中央显示一个"选择文件"按钮。

2.  **选择文件后**：
    -   界面显示已选择的文件名（例如，"已选择: `example.xlsx`"）。
    -   下方提供两个按钮："重新选择"和"翻译"。

3.  **翻译进行中**：
    -   所有按钮消失，界面显示状态提示"正在翻译..."。
    -   下方会实时更新当前正在处理的"原文"和"译文"片段。

4.  **翻译完成，等待保存**：
    -   系统自动弹出文件保存对话框。
    -   GUI 界面显示"翻译成功"的状态提示。

5.  **文件保存后**：
    -   GUI 界面显示"保存成功"的状态提示。
    -   下方显示一个"下一个"按钮，用于开始新的翻译流程。点击后，界面将重置回**初始状态**。

6.  **取消或失败**：
    -   如果在文件选择或保存阶段用户取消了操作，界面会显示"已取消"并返回相应的前置状态。
    -   如果任何步骤出现错误，界面会显示具体的错误信息。

## 4. 技术实现亮点

-   **状态驱动的 UI (State-Driven UI)**：
    -   整个 GUI 的渲染逻辑由一个核心的 `guiState` 结构体驱动。该结构体包含了所有界面元素的状态、文件路径、处理标志位等。
    -   `renderUI` 函数根据 `guiState` 的当前值来决定渲染哪些组件（按钮、文本）以及它们的布局，使得 UI 能够清晰地反映应用的内部状态。

-   **并发模型与通道通信 (Concurrency & Channels)**：
    -   为了保持 UI 的响应性，文件 I/O（选择和保存）和核心翻译逻辑（`processFunc`）都在单独的 goroutine 中执行。
    -   使用 Go 的通道（channels）在主 UI 循环和后台 goroutine 之间进行安全通信：
        -   `fileOpResultChan`: 传递文件操作（选择/保存）的结果。
        -   `processResultChan`: 传递翻译或文件复制操作的结果（成功或错误）。
        -   `translationChan`: 从翻译核心向 UI 实时传递原文和译文片段。

-   **健壮的文件处理**：
    -   **原生文件对话框**：通过 `gioui.org/x/explorer` 库与操作系统的文件浏览器集成，提供原生的用户体验。
    -   **临时文件策略**：翻译过程中的输出首先被写入一个位于系统临时目录中的文件。只有当用户在保存对话框中确认保存后，这个临时文件才会被复制到最终的目标位置。这种策略可以防止因程序中途崩溃或用户取消操作而导致的不完整或损坏的输出文件。
    -   **自动清理**：临时文件和目录在成功保存或程序退出时会被尝试删除，避免了磁盘空间的浪费。

## 5. `gui/gui.go` 主要函数与结构解析

-   **`guiState` struct**:
    -   GUI 的核心状态机。它聚合了所有窗口、主题、按钮、状态文本以及用于 goroutine 通信的通道。

-   **`CreateGUI(...)` function**:
    -   GUI 模块的入口函数。它初始化窗口、`guiState`，并启动主事件循环 `run()`。

-   **`run()` function**:
    -   GUI 的主事件循环。它在一个 `for` 循环中监听并处理来自 Gio 窗口的事件（如帧绘制、销毁）和来自通道的消息。
    -   **`select` 语句**是此函数的核心，用于非阻塞地处理来自文件操作、翻译进程和 UI 事件的各种消息。

-   **`renderUI(...)` function**:
    -   负责根据当前的 `guiState` 绘制每一帧的界面。它通过条件判断来切换不同状态下的布局（例如，初始状态、文件已选状态、处理中状态、完成状态）。

-   **`buttonLayout(...)` & `drawBackground(...)`**:
    -   辅助函数，分别用于定义按钮的统一样式和绘制窗口背景色，实现了表现与逻辑的分离。

-   **`FileOpType` enum & `explorerResult` struct**:
    -   用于在文件操作通道中区分是"选择文件"还是"保存文件"操作，并封装其结果。 
